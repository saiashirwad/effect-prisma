# effect-prisma

**Generated:** 2026-01-04 | **Commit:** f32ab12 | **Branch:** master

## OVERVIEW

Prisma generator that outputs Effect-TS wrapped repositories + schemas. Runs via `prisma generate`, produces type-safe CRUD with Effect error handling.

## STRUCTURE

```
src/
├── bin.ts                 # CLI entry (shebang, imports generator)
├── generator.ts           # Prisma generator handler (onManifest/onGenerate)
├── index.ts               # Re-exports runtime
├── generator/
│   ├── templates.ts       # Code generation templates (repos, schemas, errors)
│   └── utils.ts           # String transforms + Prisma→Effect type mapping
└── runtime/
    ├── prisma-client.ts   # Prisma Context.Tag, Layers, exec helper
    ├── errors.ts          # TaggedError types with P-code parsing
    ├── decimal.ts         # Schema transform for Prisma.Decimal
    └── index.ts           # Public API re-exports
examples/basic/            # Working example (User/Post models)
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add CRUD method | `src/generator/templates.ts` | `generateRepositoryInterface` + `generateRepositoryMethods` |
| Add new error type | `src/runtime/errors.ts` | Copy existing TaggedError pattern |
| Add Prisma type mapping | `src/generator/utils.ts` | `mapPrismaTypeToEffectSchema` switch |
| Change generated file structure | `src/generator.ts` | `onGenerate` orchestration |
| Modify runtime exports | `src/runtime/index.ts` | Update re-exports |

## CONVENTIONS

### Effect Patterns (FOLLOW THESE)
- `Context.Tag` for service dependencies (`Prisma`, `PrismaService`)
- `Layer.succeed`/`Layer.scoped` for providing implementations
- `Effect.Service` for repository container (`DB` class)
- `Schema.TaggedError` for typed errors with Prisma code parsing
- `Schema.transform` for bidirectional type conversions

### Code Generation
- File naming: `toSnakeCase(ModelName)` → `user_profile.ts`
- Header comment: `// This file was generated by effect-prisma, do not edit manually.`
- Imports use `.js` extension (ESM resolution)
- Each model → interface + factory function pattern

### TypeScript
- ESM only (`"type": "module"`)
- Strict mode with `noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`
- Two tsconfigs: `tsconfig.json` (dev, noEmit) + `tsconfig.build.json` (dist output)

## ANTI-PATTERNS (ALLOWED HERE)

```typescript
// OK in generated code only - Prisma types are complex
db.${modelNameCamel}.findFirstOrThrow(args ?? ({} as any))
return mapError ? Effect.mapError(effect, mapError) : effect;

// eslint-disable comment is intentional in generated files
/* eslint-disable @typescript-eslint/no-explicit-any */
```

**NOT OK in src/**:
- No `as any` in generator/runtime code
- No type assertions without runtime validation

## ERROR HANDLING

Prisma error codes → semantic kinds:
| Code | Kind | Used By |
|------|------|---------|
| P2002 | UNIQUE_CONSTRAINT | CreateError, UpdateError |
| P2025 | RECORD_NOT_FOUND | NotFoundError |
| P2003 | FOREIGN_KEY_CONSTRAINT | CreateError, DeleteError |
| P2011 | NULL_CONSTRAINT | CreateError, UpdateError |
| P2014 | RELATION_VIOLATION | DeleteError |

## COMMANDS

```bash
bun run build     # Clean + compile to dist/
bun run dev       # Build + regenerate example
bun test          # Run tests
```

## TESTING CHANGES

```bash
# After modifying generator
bun run dev
# Check examples/basic/generated/effect/ for output
# Run example: cd examples/basic && bun run src/index.ts
```

## PACKAGE EXPORTS

```
effect-prisma           → dist/index.js (runtime re-exports)
effect-prisma/runtime   → dist/runtime/index.js (Prisma tag, layers, errors)
```

Binary: `effect-prisma` → `dist/bin.js` (Prisma generator entry)
