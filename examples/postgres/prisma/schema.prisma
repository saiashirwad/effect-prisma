generator client {
  provider = "prisma-client-js"
}

generator effect {
  provider = "node ../../dist/bin.js"
  output   = "../generated/effect"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum TaskPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

// Organization - top level entity
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        Bytes?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teams   Team[]
  members OrganizationMember[]
}

// Organization membership (many-to-many with role)
model OrganizationMember {
  id             String       @id @default(cuid())
  role           UserRole     @default(MEMBER)
  joinedAt       DateTime     @default(now())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

// Team within an organization
model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  @default("#6366f1")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  members  TeamMember[]
  projects Project[]

  @@unique([organizationId, name])
}

// Team membership
model TeamMember {
  id       String   @id @default(cuid())
  role     UserRole @default(MEMBER)
  joinedAt DateTime @default(now())

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

// User
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  avatarUrl    String?
  timezone     String    @default("UTC")
  lastActiveAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Self-referential relation (manager hierarchy)
  managerId String?
  manager   User?   @relation("UserManager", fields: [managerId], references: [id])
  reports   User[]  @relation("UserManager")

  organizations  OrganizationMember[]
  teams          TeamMember[]
  ownedProjects  Project[]            @relation("ProjectOwner")
  assignedTasks  Task[]               @relation("TaskAssignee")
  createdTasks   Task[]               @relation("TaskCreator")
  comments       Comment[]
  timeEntries    TimeEntry[]
}

// Project
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  budget      Decimal?      @db.Decimal(12, 2)
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  settings    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  ownerId String
  owner   User   @relation("ProjectOwner", fields: [ownerId], references: [id])

  tasks Task[]
  tags  Tag[]

  @@unique([teamId, name])
}

// Task
model Task {
  id            String       @id @default(cuid())
  title         String
  description   String?
  status        TaskStatus   @default(BACKLOG)
  priority      TaskPriority @default(MEDIUM)
  estimateHours Decimal?     @db.Decimal(6, 2)
  dueDate       DateTime?
  completedAt   DateTime?
  position      Int          @default(0)
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Self-referential for subtasks
  parentId String?
  parent   Task?   @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks Task[]  @relation("TaskSubtasks")

  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])

  creatorId String
  creator   User   @relation("TaskCreator", fields: [creatorId], references: [id])

  comments    Comment[]
  timeEntries TimeEntry[]
  tags        Tag[]

  @@index([projectId, status])
  @@index([assigneeId, status])
}

// Comment on tasks
model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Self-referential for replies
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")
}

// Time tracking
model TimeEntry {
  id          String    @id @default(cuid())
  description String?
  hours       Decimal   @db.Decimal(6, 2)
  date        DateTime  @db.Date
  billable    Boolean   @default(true)
  invoiced    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId, date])
  @@index([taskId])
}

// Tags (many-to-many with projects and tasks)
model Tag {
  id        String   @id @default(cuid())
  name      String
  color     String   @default("#94a3b8")
  createdAt DateTime @default(now())

  projects Project[]
  tasks    Task[]

  @@unique([name])
}
